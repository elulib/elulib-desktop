name: Publish Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.label }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: macOS (Apple Silicon)
            os: macos-latest
            target: aarch64-apple-darwin
          - label: macOS (Intel)
            os: macos-15-intel
            target: x86_64-apple-darwin
          - label: Windows (x64)
            os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Install Tauri CLI (cargo subcommand)
        if: matrix.target == 'aarch64-apple-darwin' || matrix.target == 'x86_64-apple-darwin'
        run: cargo install tauri-cli --locked

      # Windows build using Tauri action
      - name: Build Windows
        if: matrix.target == 'x86_64-pc-windows-msvc'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          WINDOWS_CERTIFICATE: ${{ secrets.MICROSOFT_AUTHENTICODE_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.MICROSOFT_AUTHENTICODE_CERTIFICATE_PASSWORD }}
        with:
          args: --target ${{ matrix.target }} --bundles nsis
          tagName: ${{ github.ref_name }}
          releaseId: ${{ github.event.release.id }}
          releaseName: ${{ github.event.release.name }}
          releaseBody: ${{ github.event.release.body }}
          releaseDraft: false
          prerelease: ${{ github.event.release.prerelease }}

      # macOS build (manual to avoid signing during build)
      - name: Build macOS app
        if: matrix.target == 'aarch64-apple-darwin' || matrix.target == 'x86_64-apple-darwin'
        run: |
          cd src-tauri
          cargo tauri build --target ${{ matrix.target }} --bundles app,dmg
        env:
          APPLE_CERTIFICATE: ""
          APPLE_CERTIFICATE_PASSWORD: ""
          APPLE_SIGNING_IDENTITY: ""

      - name: Upload macOS artifacts
        if: matrix.target == 'aarch64-apple-darwin' || matrix.target == 'x86_64-apple-darwin'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.dmg
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign macOS app
        if: matrix.target == 'aarch64-apple-darwin' || matrix.target == 'x86_64-apple-darwin'
        run: |
          APP_BUNDLE=$(find src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.app" -type d | head -1)
          
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain"
          KEYCHAIN_PASSWORD=$(openssl rand -base64 12)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          CERT_FILE=$(mktemp).p12
          echo "$APPLE_DEVELOPER_CERTIFICATE" | base64 -d > "$CERT_FILE" 2>/dev/null || echo "$APPLE_DEVELOPER_CERTIFICATE" > "$CERT_FILE"
          
          security import "$CERT_FILE" -k "$KEYCHAIN_PATH" -P "$APPLE_DEVELOPER_CERTIFICATE_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"
          
          SIGNING_IDENTITY="$APPLE_SIGNING_IDENTITY"
          if [ -z "$SIGNING_IDENTITY" ]; then
            SIGNING_IDENTITY=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep "Developer ID" | head -1 | sed 's/.*"\(.*\)".*/\1/')
          fi
          
          codesign --force --deep --sign "$SIGNING_IDENTITY" --timestamp "$APP_BUNDLE"
          codesign --verify --verbose "$APP_BUNDLE"
          
          rm -f "$CERT_FILE"
          security delete-keychain "$KEYCHAIN_PATH"
        env:
          APPLE_DEVELOPER_CERTIFICATE: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE }}
          APPLE_DEVELOPER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_DEVELOPER_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}

      - name: Sign Windows installer
        if: matrix.target == 'x86_64-pc-windows-msvc'
        run: |
          INSTALLER_PATH=$(find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.exe" -o -name "*.msi" -o -name "*.zip" | head -1)
          
          CERT_FILE=$(mktemp).pfx
          echo "$MICROSOFT_AUTHENTICODE_CERTIFICATE" | base64 -d > "$CERT_FILE" 2>/dev/null || echo "$MICROSOFT_AUTHENTICODE_CERTIFICATE" > "$CERT_FILE"
          
          certutil -f -p "$MICROSOFT_AUTHENTICODE_CERTIFICATE_PASSWORD" -importpfx "$CERT_FILE" NoRoot
          
          if [[ "$INSTALLER_PATH" == *.exe ]] || [[ "$INSTALLER_PATH" == *.msi ]]; then
            signtool sign /f "$CERT_FILE" /p "$MICROSOFT_AUTHENTICODE_CERTIFICATE_PASSWORD" /t http://timestamp.digicert.com "$INSTALLER_PATH"
          fi
          
          rm -f "$CERT_FILE"
        env:
          MICROSOFT_AUTHENTICODE_CERTIFICATE: ${{ secrets.MICROSOFT_AUTHENTICODE_CERTIFICATE }}
          MICROSOFT_AUTHENTICODE_CERTIFICATE_PASSWORD: ${{ secrets.MICROSOFT_AUTHENTICODE_CERTIFICATE_PASSWORD }}

      - name: Generate artifact signature
        id: sign
        run: |
          if [[ "${{ matrix.target }}" == *"darwin"* ]]; then
            if [[ "${{ matrix.target }}" == *"aarch64"* ]]; then
              PLATFORM_KEY="darwin-aarch64"
            else
              PLATFORM_KEY="darwin-x86_64"
            fi
            ARTIFACT_PATH=$(find src-tauri/target/${{ matrix.target }}/release/bundle/macos -name "*.dmg" | head -1)
          else
            PLATFORM_KEY="windows-x86_64"
            ARTIFACT_PATH=$(find src-tauri/target/${{ matrix.target }}/release/bundle -name "*.zip" | head -1)
          fi
          
          KEY_FILE=$(mktemp)
          chmod 600 "$KEY_FILE"
          echo "$TAURI_SIGNING_PRIVATE_KEY" | base64 -d > "$KEY_FILE" 2>/dev/null || echo "$TAURI_SIGNING_PRIVATE_KEY" > "$KEY_FILE"
          
          SIGNATURE=$(npx @tauri-apps/cli signer sign "$ARTIFACT_PATH" --key "$KEY_FILE" --password "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD" 2>&1 | tail -1)
          
          rm -f "$KEY_FILE"
          
          echo "signature=$SIGNATURE" >> $GITHUB_OUTPUT
          echo "platform_key=$PLATFORM_KEY" >> $GITHUB_OUTPUT
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Create signature info file
        if: steps.sign.outputs.signature != ''
        run: |
          echo "${{ steps.sign.outputs.platform_key }}|${{ steps.sign.outputs.signature }}" > signature-info.txt

      - name: Upload signature artifact
        if: steps.sign.outputs.signature != ''
        uses: actions/upload-artifact@v4
        with:
          name: signature-${{ matrix.target }}
          path: signature-info.txt
          retention-days: 30

  publish-manifest:
    name: Upload updater manifest
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download signature artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: signature-*
          merge-multiple: true
          path: signatures

      - name: Update manifest
        run: |
          python - <<'PY'
          import json
          import os
          from datetime import datetime, timezone
          from pathlib import Path

          path = "src-tauri/tauri.update.json"
          with open(path, "r", encoding="utf-8") as reader:
              data = json.load(reader)

          tag = os.environ.get("TAG_NAME", "")
          version = tag[1:] if tag.startswith("v") else tag
          
          data["version"] = version
          data["notes"] = os.environ.get("RELEASE_NOTES", "")
          data["pub_date"] = os.environ.get("RELEASE_DATE", datetime.now(timezone.utc).isoformat().replace("+00:00", "Z"))

          base_url = f"https://github.com/elulib/desktop-app/releases/download/{tag}"
          platforms = data.get("platforms", {})
          
          files = {
              "darwin-x86_64": f"elulib_{version}_x64.dmg",
              "darwin-aarch64": f"elulib_{version}_aarch64.dmg",
              "windows-x86_64": f"elulib_{version}_x64-setup.nsis.zip",
          }
          
          signatures = {}
          signatures_dir = Path("signatures")
          if signatures_dir.exists():
              for sig_file in signatures_dir.rglob("signature-info.txt"):
                  with open(sig_file, "r", encoding="utf-8") as f:
                      line = f.read().strip()
                      if "|" in line:
                          platform_key, signature = line.split("|", 1)
                          signatures[platform_key] = signature.strip()

          for platform, filename in files.items():
              entry = platforms.get(platform)
              if entry:
                  entry["url"] = f"{base_url}/{filename}"
                  if platform in signatures:
                      entry["signature"] = signatures[platform]

          with open(path, "w", encoding="utf-8") as writer:
              json.dump(data, writer, indent=2)
              writer.write("\n")
          PY
        env:
          TAG_NAME: ${{ github.ref_name }}
          RELEASE_NOTES: ${{ github.event.release.body }}
          RELEASE_DATE: ${{ github.event.release.published_at }}

      - name: Attach manifest to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: src-tauri/tauri.update.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
